version: "3"

services:
 # https://grafana.com/docs/loki/latest/
  loki:
    image: grafana/loki
    pull_policy: always
    command: "-config.file=/etc/loki/local-config.yaml"
    restart: unless-stopped
    ports:
      - 3100:3100
    volumes:
      - ./data/loki/loki-config.yml:/etc/loki/local-config.yaml
      #- loki-data:/tmp/loki/:rw
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.loki.rule=Host(`loki.${DOMAIN}`)
      - traefik.http.routers.loki.tls=true
      - traefik.http.routers.loki.tls.certresolver=monitor
      #- traefik.http.routers.loki.middlewares=loki-auth@file
      - traefik.http.routers.loki.service=loki
      - traefik.http.services.loki.loadbalancer.server.port=3100
      - org.label-schema.group=monitoring
    environment:
      - TZ=Europe/Oslo
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - proxy
      - monitor-net

  alloy:
    image: grafana/alloy
    pull_policy: always
    restart: on-failure
    ports:
      - 12345:12345/tcp
      - 5514:5514/udp
      - 6514:6514/tcp
    volumes:
      - ./data/alloy:/etc/alloy
      - syslog:/var/log/external/syslogng:ro
    environment:
      LOKI_HOST: loki:3100
      #REMOTE_WRITE_HOST: mimir:9009
      #TEMPO_HOST: tempo:4317
      #PYROSCOPE_HOST: pyroscope:4040
    depends_on:
      - loki
      #- mimir
      #- tempo
      #- pyroscope
    command:
      - run
      - /etc/alloy/config.alloy
      - --storage.path=/var/lib/alloy/data
      - --server.http.listen-addr=0.0.0.0:12345
      - --stability.level=experimental # Enable all functionality
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.alloy.rule=Host(`${DOMAIN}`) && PathPrefix(`/alloy`)
      - traefik.http.routers.alloy.middlewares=compress@file
      - traefik.http.routers.alloy.tls=true
      - traefik.http.routers.alloy.tls.certresolver=monitor
    networks:
      - proxy
      - monitor-net

  # https://grafana.com/docs/loki/latest/send-data/promtail/
  promtail:
    image: grafana/promtail
    pull_policy: always
    restart: unless-stopped
    volumes:
      - ./data/promtail/promtail-config.yml:/etc/promtail/config.yaml:ro
      - /var/log:/var/log/host/:ro
      - traefik-logs:/var/log/external/traefik:ro
      - syslog:/var/log/external/syslogng:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/config.yaml
    environment:
      - TZ=Europe/Oslo
    depends_on:
      - loki
    networks:
      - monitor-net

volumes:
  loki-data:
    external: true
  traefik-logs:
    external: true
  syslog:
    external: true

networks:
  monitor-net:
    external: true
  proxy:
    external: true